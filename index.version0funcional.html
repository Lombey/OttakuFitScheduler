<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OttakuFitScheduler - Gesti√≥n de Turnos con IA</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat version for direct HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Helpers para Fechas y Horas (Globales) ---
        const getTodayString = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset();
            const local = new Date(d.getTime() - (offset*60*1000));
            return local.toISOString().split('T')[0];
        };
        
        const getMinTime = () => {
            const now = new Date();
            let currentMinutes = now.getMinutes();
            let nextMinutes = Math.ceil(currentMinutes / 15) * 15;
            let nextHour = now.getHours();

            if (nextMinutes >= 60) {
                nextMinutes = 0;
                nextHour += 1;
            }
            if (nextHour > 21 || (nextHour === 21 && nextMinutes > 45)) {
                return null; 
            }
            return `${String(nextHour).padStart(2, '0')}:${String(nextMinutes).padStart(2, '0')}`;
        };
        
        const generateTimeSlots = () => {
            const slots = [];
            for (let h = 8; h <= 21; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 21 && m > 45) break;
                    const hour = String(h).padStart(2, '0');
                    const minute = String(m).padStart(2, '0');
                    slots.push(`${hour}:${minute}`);
                }
            }
            return slots;
        };
        const timeSlots = generateTimeSlots();

        const getAvailableTimeSlots = (selectedDate) => {
            const today = getTodayString();
            const minTime = getMinTime();
            if (selectedDate === today && minTime) {
                return timeSlots.filter(slot => slot >= minTime);
            }
            return timeSlots;
        };

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = ""; // API Key se inyecta en el entorno de prueba
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una respuesta.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Hubo un error al conectar con la IA.";
            }
        };

        // --- Firebase Configuration & Initialization (H√çBRIDO) ---
        
        let firebaseConfig;
        let appId;

        // 1. Intentar cargar configuraci√≥n del entorno (Para que funcione el bot√≥n "Preview" aqu√≠)
        if (window.__firebase_config) {
            try {
                firebaseConfig = JSON.parse(window.__firebase_config);
                appId = window.__app_id || 'default-app-id';
                console.log("Cargando configuraci√≥n de entorno de prueba.");
            } catch (e) {
                console.error("Error parseando config de entorno", e);
            }
        }

        // 2. Si no hay config de entorno (Est√°s en GitHub/Producci√≥n), usar la manual con TUS DATOS
        if (!firebaseConfig) {
            // --- CONFIGURACI√ìN PARA GITHUB / PRODUCCI√ìN ---
            // DATOS REALES DE FIREBASE PROPORCIONADOS POR MARTIN
            firebaseConfig = {
                apiKey: "AIzaSyBa_YrZXpzrsLqHpLZP22DkFJ4M80epuyw",
                authDomain: "ottakufit-scheduler.firebaseapp.com",
                projectId: "ottakufit-scheduler",
                storageBucket: "ottakufit-scheduler.firebasestorage.app",
                messagingSenderId: "382792722952",
                appId: "1:382792722952:web:183878320850e456bcbfbd",
                measurementId: "G-WK7JE75H96"
            };
            appId = 'ottaku-production-v1'; // ID fijo para producci√≥n
        }

        // 3. Validaci√≥n final antes de iniciar
        // Verificamos si projectId sigue siendo el placeholder (ya no deber√≠a serlo)
        if (firebaseConfig.projectId === "TU_PROYECTO_ID" && !window.__firebase_config) {
            console.error("¬°FALTA CONFIGURAR FIREBASE!");
            document.body.innerHTML = `
                <div style="display:flex; height:100vh; align-items:center; justify-content:center; flex-direction:column; font-family:sans-serif; text-align:center; padding:20px; background-color: #fef2f2;">
                    <h1 style="color:#ef4444; font-size:24px; margin-bottom:10px;">‚ö†Ô∏è Configuraci√≥n Incompleta</h1>
                    <p style="color:#374151; max-width:600px; line-height: 1.6;">
                        Error de configuraci√≥n. Revisa el archivo index.html.
                    </p>
                </div>
            `;
            throw new Error("Firebase config incomplete"); // Detener ejecuci√≥n
        }

        // Inicializaci√≥n
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Definici√≥n de colecciones
        const getAppointmentsCollection = () => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('appointments');
        const getUsersCollection = () => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');

        const { useState, useEffect } = React;

        // --- Components ---
        const Icon = ({ name, size = 20, className = "", onClick = null }) => {
            // Simple SVG icon mapping
            const icons = {
                'calendar': <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>,
                'user': <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                'map-pin': <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
                'phone': <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                'check-circle': <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                'x-circle': <><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></>,
                'clock': <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                'log-out': <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
                'edit': <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                'lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                'trash': <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
                'filter': <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>,
                'sparkles': <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>,
                'message-circle': <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>,
                'copy': <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
                'user-check': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M16 11l2 2 4-4"/></>,
                'eye': <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
                'eye-off': <><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a1.8 1.8 0 0 1-.3-1"/><path d="M22 12s-3 7-10 7a10.07 10.07 0 0 1-5.94-2.06"/><line x1="2" x2="22" y1="2" y2="22"/><circle cx="12" cy="12" r="3"/><path d="M6 6l-3-3"/></>,
                'send': <><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                'mail': <><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>{icons[name]}</svg>;
        };

        const PasswordInput = ({ name, placeholder, value, onChange }) => {
            const [show, setShow] = useState(false);
            return (
                <div className="relative mt-1">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon name="lock" size={16}/></div>
                    <input required type={show ? "text" : "password"} name={name} className="pl-10 block w-full border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500" placeholder={placeholder} value={value} onChange={onChange}/>
                    <button type="button" onClick={(e) => {e.preventDefault(); setShow(!show);}} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition" title={show ? "Ocultar" : "Mostrar"}><Icon name={show ? "eye-off" : "eye"} size={16}/></button>
                </div>
            );
        };

        const AiModal = ({ title, content, onClose, onCopy }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center text-white">
                        <div className="flex items-center gap-2"><Icon name="sparkles" size={20} className="text-yellow-300"/><h3 className="font-bold">{title}</h3></div>
                        <button onClick={onClose} className="hover:bg-white/20 rounded-full p-1 transition"><Icon name="x-circle" size={24}/></button>
                    </div>
                    <div className="p-6"><div className="bg-gray-50 rounded-lg p-4 text-gray-700 text-sm leading-relaxed border border-gray-200">{content}</div></div>
                    <div className="p-4 border-t bg-gray-50 flex justify-end gap-2">
                         <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium">Cerrar</button>
                         {onCopy && (<button onClick={onCopy} className="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="copy" size={16}/> Copiar</button>)}
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('login');
            const [appointments, setAppointments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isLoginLoading, setIsLoginLoading] = useState(false);
            
            // Filtro por defecto: Hoy
            const [filterDate, setFilterDate] = useState(getTodayString());
            
            // Estados UI
            const [aiModalOpen, setAiModalOpen] = useState(false);
            const [aiTitle, setAiTitle] = useState('');
            const [aiContent, setAiContent] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [selectedType, setSelectedType] = useState('Musculaci√≥n');
            const [studentTip, setStudentTip] = useState(null);
            const [tipLoading, setTipLoading] = useState(false);
            const [selectedBookDate, setSelectedBookDate] = useState(getTodayString());

            useEffect(() => {
                const initAuth = async () => {
                    if (window.__initial_auth_token) await auth.signInWithCustomToken(window.__initial_auth_token);
                    else if (!auth.currentUser) await auth.signInAnonymously();
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => { setUser(u); setLoading(false); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (loading || isLoginLoading) return;
                if (!profile) { if (view !== 'register') setView('login'); }
                else if (profile.role === 'student' && (!profile.address || !profile.phone)) { setView('complete-profile'); }
                else { if (view === 'login' || view === 'register') setView('dashboard'); }
            }, [user, profile, loading, isLoginLoading]);

            useEffect(() => {
                if (!user) return;
                const unsubscribeDb = getAppointmentsCollection().onSnapshot((snapshot) => {
                    const apps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    apps.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
                    setAppointments(apps);
                }, (error) => console.error(error));
                return () => unsubscribeDb();
            }, [user]);

            const fetchUserProfile = async (email, role) => {
                const userDocRef = getUsersCollection().doc(email);
                const userDoc = await userDocRef.get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    if (data.role !== role) await userDocRef.update({ role });
                    return data;
                } else {
                    const name = email.split('@')[0];
                    const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
                    const newUser = { email, role, name: capitalizedName, createdAt: new Date().toISOString() };
                    await userDocRef.set(newUser);
                    return newUser;
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoginLoading(true);
                const formData = new FormData(e.target);
                const email = formData.get('email').toLowerCase().trim();
                const password = formData.get('password');
                const isCoach = email === 'gastonparrado@me.com';
                const requiredPassword = isCoach ? '1234' : '123';
                const role = isCoach ? 'coach' : 'student';

                if (password !== requiredPassword) {
                    alert("Contrase√±a incorrecta.");
                    setIsLoginLoading(false);
                    return;
                }
                try {
                    if (!auth.currentUser) await auth.signInAnonymously();
                    const userProfile = await fetchUserProfile(email, role);
                    setProfile(userProfile);
                } catch (error) { console.error(error); alert("Error al conectar: " + error.message); } 
                finally { setIsLoginLoading(false); }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setIsLoginLoading(true);
                const formData = new FormData(e.target);
                const email = formData.get('email').toLowerCase().trim();
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');
                const name = formData.get('name');
                const address = formData.get('address');
                const phone = formData.get('phone');

                if (password !== confirmPassword) { alert("Las contrase√±as no coinciden."); setIsLoginLoading(false); return; }
                if (email === 'gastonparrado@me.com') { alert("Email reservado."); setIsLoginLoading(false); return; }

                try {
                    const userDocRef = getUsersCollection().doc(email);
                    const userDoc = await userDocRef.get();
                    if (userDoc.exists) { alert("Email ya registrado."); setView('login'); return; }
                    
                    const newUserProfile = { email, role: 'student', name, address, phone, createdAt: new Date().toISOString() };
                    if (!user) await auth.signInAnonymously();
                    await userDocRef.set(newUserProfile);
                    setProfile(newUserProfile);
                    setView('dashboard');
                } catch (error) { console.error(error); alert("Error al registrar."); } 
                finally { setIsLoginLoading(false); }
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const updatedProfile = { ...profile, name: formData.get('name'), address: formData.get('address'), phone: formData.get('phone') };
                try { await getUsersCollection().doc(profile.email).update(updatedProfile); setProfile(updatedProfile); setView('dashboard'); } catch (error) { console.error(error); }
            };

            const handleLogout = async () => { try { await auth.signOut(); } catch(e){} setProfile(null); setFilterDate(getTodayString()); setView('login'); };

            const handleBook = async (e) => {
                e.preventDefault();
                if (!user || !profile) return;
                const formData = new FormData(e.target);
                const date = formData.get('date');
                const time = formData.get('time');
                const message = formData.get('message'); 

                const now = new Date();
                const selectedDateTime = new Date(`${date}T${time}:00`);
                if (selectedDateTime <= now) { alert("La fecha/hora debe ser futura."); return; }
                
                try {
                    await getAppointmentsCollection().add({
                        studentName: profile.name,
                        studentAddress: profile.address,
                        studentPhone: profile.phone,
                        studentEmail: profile.email,
                        studentId: user.uid,
                        date, time, type: selectedType,
                        message: message || "",
                        coachMessage: "", 
                        status: 'Pendiente',
                        createdAt: new Date().toISOString()
                    });
                    e.target.reset();
                    setSelectedBookDate(getTodayString());
                    setStudentTip(null);
                    alert("¬°Turno solicitado!");
                } catch (error) { console.error(error); alert("Error al agendar."); }
            };

            const handleStatusChange = async (docId, newStatus) => {
                try { await getAppointmentsCollection().doc(docId).update({ status: newStatus }); } catch (error) { console.error(error); }
            };

            const handleDelete = async (docId) => {
                if(confirm("¬øEliminar registro?")) { try { await getAppointmentsCollection().doc(docId).delete(); } catch (error) { console.error(error); } }
            };

            const handleGetStudentTip = async () => {
                setTipLoading(true);
                const prompt = `Nutricionista deportivo breve (max 20 palabras): qu√© consumir 1h antes de ${selectedType}? Usa emojis.`;
                const result = await callGemini(prompt);
                setStudentTip(result);
                setTipLoading(false);
            };

            const handleGenerateCoachMessage = async (app) => {
                setAiLoading(true);
                setAiTitle(`Mensaje para ${app.studentName}`);
                setAiModalOpen(true);
                setAiContent("Generando...");
                const prompt = `Mensaje WhatsApp corto coach a alumno: Confirmar turno ${app.type} el ${app.date} ${app.time}. Profesional y motivador.`;
                const result = await callGemini(prompt);
                setAiContent(result);
                setAiLoading(false);
            };

            const handleSendCoachMessage = async (docId, msg) => {
                if (!msg.trim()) return;
                try {
                    await getAppointmentsCollection().doc(docId).update({ coachMessage: msg });
                    alert("Mensaje enviado/guardado.");
                } catch (error) { console.error(error); alert("Error al enviar mensaje."); }
            };

            const copyToClipboard = () => {
                try {
                    const ta = document.createElement("textarea");
                    ta.value = aiContent;
                    ta.style.position="fixed"; ta.style.left="-9999px";
                    document.body.appendChild(ta); ta.focus(); ta.select();
                    document.execCommand('copy'); document.body.removeChild(ta);
                    alert("Copiado!");
                } catch (e) { alert("Copia manual requerida."); }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold">Cargando OttakuFitScheduler...</div>;

            if (view === 'login') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md fade-in border-t-4 border-blue-600">
                        <div className="text-center mb-6"><h1 className="text-3xl font-bold text-gray-800">OttakuFitScheduler</h1><p className="text-gray-500">Acceso a Turnos</p></div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <div><label className="block text-sm font-medium text-gray-700">Email</label><div className="relative mt-1"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">@</div><input required type="email" name="email" className="pl-10 block w-full border-gray-300 rounded-md border p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="usuario@email.com" /></div></div>
                            <div><label className="block text-sm font-medium text-gray-700">Contrase√±a</label><PasswordInput name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                            <button type="submit" disabled={isLoginLoading} className="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition disabled:opacity-50">{isLoginLoading ? 'Ingresando...' : 'Iniciar Sesi√≥n'}</button>
                            <button type="button" onClick={() => setView('register')} className="w-full text-center py-2 text-sm text-blue-600 hover:text-blue-700 transition">¬øEres nuevo? Reg√≠strate aqu√≠</button>
                            <p className="text-xs text-center text-gray-400 mt-2">Coach: gastonparrado@me.com, clave: 1234 | Alumnos: cualquier mail, clave: 123</p>
                        </form>
                    </div>
                </div>
            );

            if (view === 'register') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md fade-in border-t-4 border-green-600">
                        <div className="text-center mb-6"><h1 className="text-3xl font-bold text-gray-800">Registro de Alumno</h1></div>
                        <form onSubmit={handleRegister} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Email</label><input required type="email" name="email" className="mt-1 block w-full border-gray-300 rounded-md border p-2" placeholder="tu@email.com" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Contrase√±a</label><PasswordInput name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Confirmar Contrase√±a</label><PasswordInput name="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                            <div className="pt-2 border-t mt-4 border-gray-100">
                                <div><label className="block text-sm font-medium text-gray-700">Nombre Completo</label><input required type="text" name="name" className="mt-1 block w-full border-gray-300 rounded-md border p-2" /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Direcci√≥n</label><input required type="text" name="address" className="mt-1 block w-full border-gray-300 rounded-md border p-2" placeholder="Ej. Av. Libertador 1234" /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Tel√©fono</label><input required type="tel" name="phone" className="mt-1 block w-full border-gray-300 rounded-md border p-2" /></div>
                            </div>
                            <button type="submit" disabled={isLoginLoading} className="w-full py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition disabled:opacity-50 mt-4">{isLoginLoading ? 'Registrando...' : 'Registrar'}</button>
                            <button type="button" onClick={() => setView('login')} className="w-full text-center py-2 text-sm text-gray-500 hover:text-gray-700 transition">Volver</button>
                        </form>
                    </div>
                </div>
            );

            if (view === 'complete-profile' || view === 'edit-profile') return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
                    <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">{view === 'complete-profile' ? 'Completar Perfil' : 'Editar Perfil'}</h2>
                        <form onSubmit={handleUpdateProfile} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Nombre</label><input required type="text" name="name" defaultValue={profile.name} className="mt-1 block w-full border-gray-300 rounded-md border p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Direcci√≥n</label><div className="relative mt-1"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon name="map-pin" size={16}/></div><input required type="text" name="address" defaultValue={profile.address || ''} className="pl-10 block w-full border-gray-300 rounded-md border p-2" /></div></div>
                            <div><label className="block text-sm font-medium text-gray-700">Tel√©fono</label><div className="relative mt-1"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon name="phone" size={16}/></div><input required type="tel" name="phone" defaultValue={profile.phone || ''} className="pl-10 block w-full border-gray-300 rounded-md border p-2" /></div></div>
                            <button type="submit" className="w-full py-2 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition">Guardar</button>
                            {view === 'edit-profile' && (<button type="button" onClick={() => setView('dashboard')} className="w-full py-2 text-gray-500 hover:text-gray-700 text-sm">Cancelar</button>)}
                        </form>
                    </div>
                </div>
            );

            let myAppointments = profile.role === 'coach' ? appointments : appointments.filter(app => app.studentName === profile.name || app.studentEmail === profile.email || app.studentId === user?.uid);
            if (filterDate && profile.role === 'coach') { myAppointments = myAppointments.filter(app => app.date === filterDate); }

            return (
                <div className="min-h-screen pb-12 relative">
                    {aiModalOpen && <AiModal title={aiTitle} content={aiContent} onClose={() => setAiModalOpen(false)} onCopy={!aiLoading ? copyToClipboard : null} />}

                    <nav className={`${profile.role === 'coach' ? 'bg-purple-700' : 'bg-blue-700'} text-white shadow-lg`}>
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center gap-2"><Icon name="calendar" className="text-white" /><span className="font-bold text-xl tracking-tight hidden sm:block">OttakuFitScheduler</span></div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right hidden sm:block"><div className="text-sm font-medium">{profile.name}</div><div className="text-xs text-gray-300 uppercase">{profile.role === 'student' ? 'ALUMNO' : profile.role}</div></div>
                                    {profile.role === 'student' && (<button onClick={() => setView('edit-profile')} className="p-2 rounded-full hover:bg-white/10 transition"><Icon name="edit" size={18}/></button>)}
                                    <button onClick={handleLogout} className="p-2 rounded-full hover:bg-white/10 transition"><Icon name="log-out" size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            
                            <div className="md:col-span-1">
                                {profile.role === 'student' ? (
                                    <div className="bg-white rounded-xl shadow-md p-6 sticky top-8">
                                        <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="check-circle" className="text-blue-600"/> Nuevo Turno</h2>
                                        <form onSubmit={handleBook} className="space-y-4">
                                            <div><label className="block text-xs font-semibold text-gray-500 uppercase">Fecha</label><input required type="date" name="date" className="mt-1 block w-full rounded-md border-gray-300 border p-2 text-sm" defaultValue={getTodayString()} min={getTodayString()} onChange={(e) => setSelectedBookDate(e.target.value)}/></div>
                                            <div><label className="block text-xs font-semibold text-gray-500 uppercase">Hora</label><select required name="time" className="mt-1 block w-full rounded-md border-gray-300 border p-2 text-sm"><option value="">Seleccionar</option>{getAvailableTimeSlots(selectedBookDate).map(slot => (<option key={slot} value={slot}>{slot}</option>))}</select></div>
                                            <div>
                                                <label className="block text-xs font-semibold text-gray-500 uppercase">Tipo de Clase</label>
                                                <select value={selectedType} onChange={(e) => { setSelectedType(e.target.value); setStudentTip(null); }} name="type" className="mt-1 block w-full rounded-md border-gray-300 border p-2 text-sm"><option value="Musculaci√≥n">Musculaci√≥n</option><option value="Funcional">Funcional</option><option value="Cardio">Cardio / Running</option><option value="Yoga">Yoga / Stretching</option></select>
                                                <button type="button" onClick={handleGetStudentTip} disabled={tipLoading} className="mt-2 text-xs flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium transition"><Icon name="sparkles" size={14}/> {tipLoading ? 'Consultando IA...' : `¬øQu√© comer antes?`}</button>
                                                {studentTip && (<div className="mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-lg text-xs text-indigo-800 fade-in"><span className="font-bold block mb-1">üí° Tip Nutricional AI:</span>{studentTip}</div>)}
                                            </div>
                                            
                                            {/* Nuevo Campo: Mensaje del Alumno */}
                                            <div>
                                                <label className="block text-xs font-semibold text-gray-500 uppercase">Mensaje al Coach (Opcional)</label>
                                                <textarea name="message" className="mt-1 block w-full rounded-md border-gray-300 border p-2 text-sm" rows="2" placeholder="Ej: Tengo una molestia en la rodilla..."></textarea>
                                            </div>

                                            <div className="bg-gray-50 p-3 rounded text-xs text-gray-500"><p className="font-semibold mb-1">Entrenaremos en:</p><p><Icon name="map-pin" size={12} className="inline mr-1"/>{profile.address}</p></div>
                                            <button type="submit" className="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">Agendar Clase</button>
                                        </form>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-xl shadow-md p-6 sticky top-8">
                                        <h2 className="text-lg font-bold text-gray-800 mb-4">Resumen Coach</h2>
                                        <div className="space-y-4">
                                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-100"><div className="text-3xl font-bold text-purple-700">{appointments.filter(a => a.status === 'Pendiente').length}</div><div className="text-sm text-purple-600">Pendientes Totales</div></div>
                                            <div className="bg-green-50 p-4 rounded-lg border border-green-100"><div className="text-3xl font-bold text-green-700">{appointments.filter(a => a.status === 'Confirmado').length}</div><div className="text-sm text-green-600">Confirmados Totales</div></div>
                                            <div className="bg-gray-100 p-4 rounded-lg border border-gray-200"><div className="text-3xl font-bold text-gray-700">{appointments.filter(a => a.status === 'Asistido').length}</div><div className="text-sm text-gray-600">Clases Asistidas</div></div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="md:col-span-2 space-y-4">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                                    <h2 className="text-xl font-bold text-gray-800">{profile.role === 'student' ? 'Mis Turnos' : (filterDate ? `Agenda del ${filterDate}` : 'Agenda Completa')}</h2>
                                    {profile.role === 'coach' && (
                                        <div className="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                                            <div className="flex items-center gap-1 text-gray-500 mr-2 border-r pr-2"><Icon name="filter" size={16}/><span className="text-xs font-bold uppercase tracking-wide">Filtro</span></div>
                                            <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="text-sm border-none focus:ring-0 p-0 text-gray-600 bg-transparent"/>
                                            {filterDate ? (<button onClick={() => setFilterDate('')} className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition">Ver Todos</button>) : (<button onClick={() => setFilterDate(getTodayString())} className="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition">Hoy</button>)}
                                        </div>
                                    )}
                                </div>

                                {myAppointments.length === 0 ? (
                                    <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300"><Icon name="calendar" size={48} className="mx-auto text-gray-300 mb-3"/><p className="text-gray-500">{filterDate ? 'No hay turnos para esta fecha.' : 'No hay turnos agendados a√∫n.'}</p></div>
                                ) : (
                                    myAppointments.map((app) => (
                                        <div key={app.id} className={`bg-white rounded-xl shadow-sm border border-gray-200 p-5 transition duration-200 flex flex-col sm:flex-row gap-4 justify-between fade-in ${app.status === 'Rechazado' ? 'opacity-75 bg-red-50' : ''} ${app.status === 'Asistido' ? 'bg-gray-50' : ''}`}>
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold uppercase tracking-wide flex items-center gap-1 ${app.status === 'Pendiente' ? 'bg-yellow-100 text-yellow-800' : ''} ${app.status === 'Confirmado' ? 'bg-green-100 text-green-800' : ''} ${app.status === 'Asistido' ? 'bg-gray-200 text-gray-800' : ''} ${app.status === 'Rechazado' ? 'bg-red-100 text-red-800' : ''}`}>
                                                        {app.status === 'Confirmado' && <Icon name="check-circle" size={12}/>}
                                                        {app.status === 'Asistido' && <Icon name="user-check" size={12}/>}
                                                        {app.status === 'Rechazado' && <Icon name="x-circle" size={12}/>}
                                                        {app.status}
                                                    </span>
                                                    <span className="text-xs text-gray-400 font-mono">ID: {app.id.slice(0,4)}</span>
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-900">{app.type}</h3>
                                                <div className="mt-2 space-y-1 text-sm text-gray-600">
                                                    <div className="flex items-center gap-2"><Icon name="clock" size={14} className="text-gray-400"/><span className="font-medium text-gray-800">{app.date} a las {app.time}</span></div>
                                                    <div className="flex items-center gap-2 mt-1 text-gray-500"><Icon name="map-pin" size={14} className="text-gray-400"/><span>{app.studentAddress}</span></div>
                                                    {profile.role === 'coach' && (
                                                        <div className="mt-3 pt-3 border-t border-gray-100">
                                                            <div className="flex items-center gap-2 text-blue-600 font-medium"><Icon name="user" size={14}/> {app.studentName}</div>
                                                            <div className="flex items-center gap-2 mt-1"><Icon name="phone" size={14}/> {app.studentPhone}</div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Secci√≥n de Mensajes */}
                                                    <div className="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100 text-sm">
                                                        {/* Mensaje del Alumno */}
                                                        {app.message && (
                                                            <div className="mb-2">
                                                                <span className="block text-xs font-bold text-gray-500 uppercase">Nota del Alumno:</span>
                                                                <p className="text-gray-700 italic">"{app.message}"</p>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Mensaje/Respuesta del Coach */}
                                                        {app.coachMessage ? (
                                                            <div className="mt-2 pt-2 border-t border-gray-200">
                                                                <span className="block text-xs font-bold text-purple-600 uppercase">Mensaje del Coach:</span>
                                                                <p className="text-gray-800 font-medium">"{app.coachMessage}"</p>
                                                            </div>
                                                        ) : (
                                                            /* Formulario solo para Coach si no ha respondido */
                                                            profile.role === 'coach' && (
                                                                <div className="mt-2 pt-2 border-t border-gray-200">
                                                                    <span className="block text-xs font-bold text-gray-400 uppercase mb-1">Responder / Enviar Mensaje:</span>
                                                                    <form onSubmit={(e) => { e.preventDefault(); handleSendCoachMessage(app.id, e.target.response.value); }} className="flex gap-2">
                                                                        <input type="text" name="response" className="flex-1 text-xs border rounded px-2 py-1" placeholder="Escribe aqu√≠..." />
                                                                        <button type="submit" className="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700"><Icon name="send" size={12}/></button>
                                                                    </form>
                                                                </div>
                                                            )
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex flex-row sm:flex-col gap-2 justify-center border-t sm:border-t-0 sm:border-l border-gray-100 pt-4 sm:pt-0 sm:pl-4">
                                                {profile.role === 'coach' && (<button onClick={() => handleGenerateCoachMessage(app)} className="flex items-center justify-center gap-1 px-3 py-2 bg-indigo-50 text-indigo-600 border border-indigo-100 rounded text-sm hover:bg-indigo-100 w-full sm:w-auto mb-2" title="Generar WhatsApp"><Icon name="message-circle" size={16}/> <span className="sm:hidden">WhatsApp IA</span></button>)}
                                                {profile.role === 'coach' && app.status === 'Pendiente' && (<><button onClick={() => handleStatusChange(app.id, 'Confirmado')} className="flex items-center justify-center gap-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 w-full sm:w-auto">Confirmar</button><button onClick={() => handleStatusChange(app.id, 'Rechazado')} className="flex items-center justify-center gap-1 px-3 py-2 text-red-600 border border-red-200 rounded text-sm hover:bg-red-50 w-full sm:w-auto">Rechazar</button></>)}
                                                {profile.role === 'coach' && app.status === 'Confirmado' && (<button onClick={() => handleStatusChange(app.id, 'Asistido')} className="flex items-center justify-center gap-1 px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 w-full sm:w-auto">Asistido</button>)}
                                                {(app.status === 'Rechazado' || app.status === 'Asistido' || (profile.role === 'student' && app.status === 'Pendiente')) && (<button onClick={() => handleDelete(app.id)} className="flex items-center justify-center gap-1 px-3 py-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded text-sm transition" title="Eliminar"><Icon name="trash" size={16}/></button>)}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
